# Отчет по этапу 3: Реализация уровня хранения и бизнес-логики

## 1. Диаграмма классов

Диаграмма классов системы ItDrive создана и документирована в файле `docs/class-diagram.md`. Диаграмма отражает следующие уровни архитектуры:

### 1.1. Уровень модели данных (Model)
- **User** - модель пользователя с ролями (DRIVER, PASSENGER, ADMIN)
- **Driver** - расширение User для водителей с информацией об автомобиле
- **Building** - модель корпуса университета
- **Trip** - модель поездки с маршрутом и параметрами
- **Booking** - модель бронирования места в поездке
- **Review** - модель отзыва и рейтинга
- **Payment** - модель платежа

### 1.2. Уровень хранения данных (Repository)
Созданы следующие репозитории:
- `UserRepository` - работа с пользователями
- `DriverRepository` - работа с водителями
- `BuildingRepository` - работа с корпусами
- `TripRepository` - работа с поездками
- `BookingRepository` - работа с бронированиями
- `ReviewRepository` - работа с отзывами
- `PaymentRepository` - работа с платежами
- `StatisticsRepository` - получение статистики

### 1.3. Уровень бизнес-логики (Service)
Реализованы следующие сервисы:
- `UserService` - управление пользователями и авторизация
- `AuthService` - регистрация и аутентификация
- `TripService` - управление поездками
- `BookingService` - управление бронированиями
- `ReviewService` - управление отзывами
- `AdminService` - административные функции и статистика

### 1.4. Уровень представления (Controller)
Реализованы следующие REST контроллеры:
- `AuthController` - регистрация и авторизация
- `TripController` - управление поездками
- `BookingController` - управление бронированиями
- `ReviewController` - управление отзывами
- `AdminController` - административные функции
- `UserController` - управление пользователями

## 2. Реализация уровня хранения

### 2.1. PL/PGSQL функции

Создан файл `src/main/resources/db/migration/V1__create_functions.sql` с функциями:

1. **create_user** - создание пользователя в БД
2. **update_user_rating** - обновление рейтинга пользователя на основе отзывов
3. **create_trip** - создание поездки
4. **create_booking** - создание бронирования с проверкой доступности мест
5. **confirm_booking** - подтверждение бронирования водителем
6. **cancel_booking** - отмена бронирования с возвратом мест
7. **start_trip** - начало поездки
8. **complete_trip** - завершение поездки с обновлением статистики
9. **create_review** - создание отзыва с обновлением рейтинга
10. **get_trip_statistics** - получение статистики поездок
11. **get_popular_routes** - получение популярных маршрутов

### 2.2. Использование функций в репозиториях

Все репозитории используют аннотацию `@Procedure` для вызова PL/PGSQL функций:

```java
@Procedure("create_user")
Long createUser(...);

@Procedure("create_trip")
Long createTrip(...);

@Procedure("create_booking")
Long createBooking(...);
```

Функции вызываются напрямую из репозиториев, что обеспечивает выполнение бизнес-логики на уровне БД.

## 3. Реализация уровня бизнес-логики

### 3.1. Сервисы

Все бизнес-операции реализованы в сервисном слое:

#### UserService
- Регистрация пользователей через PL/PGSQL функцию
- Авторизация через UserDetailsService
- Обновление рейтинга пользователя
- Блокировка/разблокировка пользователей

#### TripService
- Создание поездок с валидацией
- Поиск поездок по критериям
- Управление жизненным циклом поездки (начало, завершение, отмена)

#### BookingService
- Создание бронирований через PL/PGSQL функцию
- Подтверждение/отмена бронирований
- Проверка доступности мест

#### ReviewService
- Создание отзывов через PL/PGSQL функцию
- Автоматическое обновление рейтинга пользователя
- Проверка возможности оставить отзыв

#### AdminService
- Получение статистики через PL/PGSQL функции
- Получение популярных маршрутов
- Управление пользователями

### 3.2. Транзакционность

Все методы сервисов помечены аннотациями `@Transactional` для обеспечения целостности данных:
- `@Transactional` - для методов изменения данных
- `@Transactional(readOnly = true)` - для методов чтения данных

## 4. Валидация данных

Использованы аннотации Jakarta Validation:
- `@NotBlank`, `@NotNull`, `@Email` - для обязательных полей
- `@Size`, `@Min`, `@Max`, `@Positive` - для проверки диапазонов значений
- `@Future` - для проверки дат в будущем

## 5. Безопасность

### 5.1. JWT авторизация
- Реализован `JwtUtil` для работы с JWT токенами
- Создан `JwtAuthenticationFilter` для фильтрации запросов
- Настроена `SecurityConfig` с использованием JWT

### 5.2. Роли и права доступа
- Роли: DRIVER, PASSENGER, ADMIN
- Административные эндпоинты защищены проверкой роли
- Текущий пользователь определяется через SecurityContext

## 6. Структура базы данных

Схема БД описана в файле `src/main/resources/db/schema.sql`:
- Созданы все необходимые таблицы
- Определены типы данных (ENUM)
- Созданы индексы для оптимизации запросов
- Настроены внешние ключи и ограничения

## 7. Заключение

Этап 3 успешно завершен:
- ✅ Создана диаграмма классов
- ✅ Реализован уровень хранения с использованием PL/PGSQL функций
- ✅ Реализован уровень бизнес-логики
- ✅ Все функции БД используются в репозиториях
- ✅ Реализована валидация и безопасность

Система готова к реализации уровня представления (REST API).
